#!/usr/bin/env node

var program = require('commander');
var starsky = require('..');
var path = require('path');

/**
 * Options.
 */

program
.version(starsky.version)
.usage('[options] consumer_module')
.option('--config [config_path]', 'yaml configuration file path')
.option('--mq_exchange [mq_exchange]', 'rabbitmq exchange name')
.option('--mq_host [mq_host]', 'rabbitmq host')
.option('--mq_port [mq_port]', 'rabbitmq port')
.option('--mq_vhost [mq_vhost]', 'rabbitmq vhost')
.option('--mq_username [mq_username]', 'rabbitmq username')
.option('--mq_password [mq_password]', 'rabbitmq password')
.option('--mq_tls [mq_tls]', 'rabbitmq tls connection')
.option('--mq_tls_cert [mq_tls_cert]', 'rabbitmq tls cert file path')
.option('--mq_tls_key [mq_tls_key]', 'rabbitmq tls key file path')
.parse(process.argv);

/**
 * Load as a consumer.
 */

var file = path.resolve(process.cwd(), program.args[0]);
var consumer = require(file);

/**
 * Eat messages.
 */

starsky.once('ready', function () {
  starsky
  .queue(consumer.queue)
  .subscribe(consumer.topic)
  .consume(consumer.consume);
});

/**
 * Connect.
 */

starsky.connect();